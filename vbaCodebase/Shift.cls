VERSION 1.0 CLASS
BEGIN
  MultiUse = -1  'True
END
Attribute VB_Name = "Shift"
Option Explicit

' Propriétés Shift
' ID : Identifiant unique du poste
Public ID As Variant
' DatePoste : Date du poste
Public DatePoste As Variant
' Operateur : Nom de l'opérateur
Public Operateur As Variant
' Vaccation : Type de vacation (matin, après-midi, nuit)
Public Vaccation As Variant
' Duree : Durée du poste en heures
Public Duree As Variant
' MachinePrisePoste : Numéro de la machine au début du poste
Public MachinePrisePoste As Variant
' LgEnrouleePrisePoste : Longueur enroulée au début du poste
Public LgEnrouleePrisePoste As Variant
' MachineFinPoste : Numéro de la machine à la fin du poste
Public MachineFinPoste As Variant
' LgEnrouleeFinPoste : Longueur enroulée à la fin du poste
Public LgEnrouleeFinPoste As Variant
' Commentaires : Commentaires additionnels sur le poste
Public Commentaires As Variant
' SaveDateTime : Date et heure de la sauvegarde
Public SaveDateTime As Variant
' Contrôles globaux
Public ctrlMoyenneMicG As Variant
Public ctrlMoyenneMicD As Variant
Public ctrlMicG1 As Variant
Public ctrlMicG2 As Variant
Public ctrlMicG3 As Variant
Public ctrlMicD1 As Variant
Public ctrlMicD2 As Variant
Public ctrlMicD3 As Variant
Public ctrlMasseSurfaciqueGG As Variant
Public ctrlMasseSurfaciqueGC As Variant
Public ctrlMasseSurfaciqueDC As Variant
Public ctrlMasseSurfaciqueDD As Variant
Public ctrlBain As Variant
Public ctrlLoi As Variant
Public ctrlSavedOnRoll As Variant

Public lgOK As Variant
Public lgNOK As Variant
Public lgScrap As Variant
Public possibleLg As Variant

' Charge les données du shift depuis la feuille
' @but : Initialise les propriétés du shift avec les valeurs de la feuille
' @param ws : Feuille contenant les données du shift
' @return : aucun
Public Sub LoadFromSheet(ws As Worksheet)
    ID = ws.Range(RANGE_SHIFT_ID).Value
    DatePoste = ws.Range(RANGE_SHIFT_DATE).Value
    Operateur = ws.Range(RANGE_SHIFT_OPERATEUR).Value
    Vaccation = ws.Range(RANGE_SHIFT_VACCATION).Value
    Duree = ws.Range(RANGE_SHIFT_DUREE).Value
    MachinePrisePoste = ws.Range(RANGE_SHIFT_MACHINE_PRISE_POSTE).Value
    LgEnrouleePrisePoste = ws.Range(RANGE_SHIFT_LG_ENROULEE_PRISE_POSTE).Value
    MachineFinPoste = ws.Range(RANGE_SHIFT_MACHINE_FIN_POSTE).Value
    LgEnrouleeFinPoste = ws.Range(RANGE_SHIFT_LG_ENROULEE_FIN_POSTE).Value
    
    ' Charger les longueurs spécifiques depuis les adresses fixes
    lgOK = ws.Range("AD49").Value
    lgNOK = ws.Range("AD50").Value
    lgScrap = ws.Range("AD48").Value
    possibleLg = ws.Range("AD47").Value
    
    ' Concaténe les lignes des commentaires
    Dim commentRange As Range
    Dim commentCell As Range
    Dim commentText As String
    
    Set commentRange = ws.Range(RANGE_SHIFT_COMMENTAIRES)
    commentText = ""
    
    For Each commentCell In commentRange
        If Not IsEmpty(commentCell.Value) Then
            If commentText <> "" Then commentText = commentText & " | "
            commentText = commentText & commentCell.Value
        End If
    Next commentCell
    
    Commentaires = commentText
    SaveDateTime = Now
End Sub

' Sauvegarde les données du shift dans la feuille
' @but : écrit les propriétés du shift dans la feuille
' @param ws : Feuille où sauvegarder les données
' @return : aucun
Public Sub SaveToSheet(ws As Worksheet)
    ws.Range(RANGE_SHIFT_ID).Value = ID
    ws.Range(RANGE_SHIFT_DATE).Value = DatePoste
    ws.Range(RANGE_SHIFT_OPERATEUR).Value = Operateur
    ws.Range(RANGE_SHIFT_VACCATION).Value = Vaccation
    ws.Range(RANGE_SHIFT_DUREE).Value = Duree
    ws.Range(RANGE_SHIFT_MACHINE_PRISE_POSTE).Value = MachinePrisePoste
    ws.Range(RANGE_SHIFT_LG_ENROULEE_PRISE_POSTE).Value = LgEnrouleePrisePoste
    ws.Range(RANGE_SHIFT_MACHINE_FIN_POSTE).Value = MachineFinPoste
    ws.Range(RANGE_SHIFT_LG_ENROULEE_FIN_POSTE).Value = LgEnrouleeFinPoste
    
    ' Répartit les commentaires sur les lignes
    Dim commentRange As Range
    Dim commentLines() As String
    Dim i As Long
    
    Set commentRange = ws.Range(RANGE_SHIFT_COMMENTAIRES)
    commentLines = Split(Commentaires, " | ")
    
    ' Efface d'abord la plage
    commentRange.ClearContents
    
    ' Répartit les lignes
    For i = 0 To UBound(commentLines)
        If i <= commentRange.Rows.Count - 1 Then
            commentRange.Cells(i + 1, 1).Value = commentLines(i)
        End If
    Next i
    ' Call ExportGlobalsCtrlToSheet
    Call ClearTimeLostRange
    call ClearGlobalsCtrlValues
    ' ws.Range(RANGE_SHIFT_SAVE_DATE_TIME).Value = SaveDateTime
End Sub

' Ajoute les données du shift à la fin de la feuille data_shifts
' @but : Enregistre un nouveau shift dans l'historique
' @param ws : Feuille data_shifts où ajouter les données
' @return : aucun
Public Sub AppendToDataShifts(ws As Worksheet)
    ' Vérification de l'état de la machine et des temps de démarrage
    If MachinePrisePoste = "A l'Arrêt" Then
        Dim hasStartupTime As Boolean
        hasStartupTime = False
        Dim cell As Range
        For Each cell In PRODUCTION_WS.Range("AC78:AC100")
            If cell.Value = "Démarrage" Then
                hasStartupTime = True
                Exit For
            End If
        Next cell
        
        If Not hasStartupTime Then
            If MsgBox("La machine était à l'arrêt à la prise de poste, mais aucun temps de démarrage déclaré, continuer quand même ?", vbQuestion + vbYesNo, "Avertissement") = vbNo Then
                Exit Sub
            End If
        End If
    End If

    Dim lastRow As Long
    Dim nextRow As Long
    Dim i As Long
    Dim shiftExists As Boolean
    
    ' Vérifie si le shift existe déjà
    lastRow = ws.Cells(ws.Rows.Count, 1).End(xlUp).Row
    shiftExists = False
    
    For i = 2 To lastRow  ' Commence à 2 pour sauter l'en-tête
        If ws.Cells(i, 1).Value = ID Then
            shiftExists = True
            MsgBox "Un poste avec l'ID " & ID & " existe déjà ...", vbExclamation, "Poste déjà existant"
            Exit Sub
        End If
    Next i
    
    ' Vérifie tous les champs obligatoires
    If ID = "" Or IsEmpty(ID) Then
        MsgBox "L'ID du poste est obligatoire.", vbExclamation, "Données manquantes"
        Exit Sub
    End If
    
    If DatePoste = "" Or IsEmpty(DatePoste) Then
        MsgBox "La date du poste est obligatoire.", vbExclamation, "Données manquantes"
        Exit Sub
    End If
    
    If Operateur = "" Or IsEmpty(Operateur) Then
        MsgBox "L'opérateur est obligatoire.", vbExclamation, "Données manquantes"
        Exit Sub
    End If
    
    If Vaccation = "" Or IsEmpty(Vaccation) Then
        MsgBox "La vacation est obligatoire.", vbExclamation, "Données manquantes"
        Exit Sub
    End If
    
    If Duree = "" Or IsEmpty(Duree) Then
        MsgBox "La durée du poste est obligatoire.", vbExclamation, "Données manquantes"
        Exit Sub
    End If
    
    If MachinePrisePoste = "" Or IsEmpty(MachinePrisePoste) Then
        MsgBox "L'état de la machine en prise de poste est obligatoire.", vbExclamation, "Données manquantes"
        Exit Sub
    End If
    
    If MachineFinPoste = "" Or IsEmpty(MachineFinPoste) Then
        MsgBox "L'état de la machine en fin de poste est obligatoire.", vbExclamation, "Données manquantes"
        Exit Sub
    End If
    
    ' Vérifie les longueurs si les machines sont démarrées
    If MachinePrisePoste = "Démarrée" And (LgEnrouleePrisePoste = "" Or IsEmpty(LgEnrouleePrisePoste)) Then
        MsgBox "La machine est démarrée en prise de poste mais aucune longueur n'est saisie.", vbExclamation, "Données manquantes"
        Exit Sub
    End If
    
    If MachineFinPoste = "Démarrée" And (LgEnrouleeFinPoste = "" Or IsEmpty(LgEnrouleeFinPoste)) Then
        MsgBox "La machine est démarrée en fin de poste mais aucune longueur n'est saisie.", vbExclamation, "Données manquantes"
        Exit Sub
    End If
    
    ' Vérification des contrôles globaux obligatoires
    If Not AreAllGlobalsCtrlFilled(True) Then
        Exit Sub
    End If
    
    ' Demande confirmation avant de sauvegarder
    If MsgBox("Voulez-vous enregistrer le poste de " & Operateur & " du " & DatePoste & " (" & Vaccation & ") ?", vbQuestion + vbYesNo, "Confirmation") = vbNo Then
        Exit Sub
    End If
    
    ' Si la feuille est vide, commence à la ligne 2 (ligne 1 pour les en-têtes)
    If lastRow = 1 And ws.Cells(1, 1).Value = "" Then
        nextRow = 2
    Else
        nextRow = lastRow + 1
    End If

    ws.Cells(nextRow, 1).Value = ID
    ws.Cells(nextRow, 2).Value = DatePoste
    ws.Cells(nextRow, 3).Value = Operateur
    ws.Cells(nextRow, 4).Value = Vaccation
    ws.Cells(nextRow, 5).Value = Duree
    ws.Cells(nextRow, 6).Value = MachinePrisePoste
    ' Longueur prise de poste uniquement si machine démarrée
    If MachinePrisePoste = "Démarrée" Then
        ws.Cells(nextRow, 7).Value = LgEnrouleePrisePoste
    Else
        ws.Cells(nextRow, 7).Value = ""
    End If
    ws.Cells(nextRow, 8).Value = MachineFinPoste
    ' Longueur fin de poste uniquement si machine démarrée
    If MachineFinPoste = "Démarrée" Then
        ws.Cells(nextRow, 9).Value = LgEnrouleeFinPoste
    Else
        ws.Cells(nextRow, 9).Value = ""
    End If
    ws.Cells(nextRow, 10).Value = Commentaires
    ws.Cells(nextRow, 11).Value = Now ' Ajout de la date/heure de sauvegarde

    ' Ajouter les en-têtes pour les longueurs spécifiques si besoin
    If ws.Cells(1, 12).Value = "" Then ws.Cells(1, 12).Value = "lgOK"
    If ws.Cells(1, 13).Value = "" Then ws.Cells(1, 13).Value = "lgNOK"
    If ws.Cells(1, 14).Value = "" Then ws.Cells(1, 14).Value = "lgScrap"
    If ws.Cells(1, 15).Value = "" Then ws.Cells(1, 15).Value = "possibleLg"

    ' Exporter les valeurs dans les colonnes correspondantes
    ws.Cells(nextRow, 12).Value = lgOK
    ws.Cells(nextRow, 13).Value = lgNOK
    ws.Cells(nextRow, 14).Value = lgScrap
    ws.Cells(nextRow, 15).Value = possibleLg

    ' Remplir les contrôles globaux
    ctrlMoyenneMicG = ""
    ctrlMoyenneMicD = ""
    Dim micG1 As Variant, micG2 As Variant, micG3 As Variant
    Dim micD1 As Variant, micD2 As Variant, micD3 As Variant
    micG1 = ThisWorkbook.Names("micG1").RefersToRange.Value
    micG2 = ThisWorkbook.Names("micG2").RefersToRange.Value
    micG3 = ThisWorkbook.Names("micG3").RefersToRange.Value
    micD1 = ThisWorkbook.Names("micD1").RefersToRange.Value
    micD2 = ThisWorkbook.Names("micD2").RefersToRange.Value
    micD3 = ThisWorkbook.Names("micD3").RefersToRange.Value
    If IsNumeric(micG1) And IsNumeric(micG2) And IsNumeric(micG3) Then
        ctrlMoyenneMicG = Round((CDbl(micG1) + CDbl(micG2) + CDbl(micG3)) / 3, 2)
    End If
    If IsNumeric(micD1) And IsNumeric(micD2) And IsNumeric(micD3) Then
        ctrlMoyenneMicD = Round((CDbl(micD1) + CDbl(micD2) + CDbl(micD3)) / 3, 2)
    End If
    ctrlMicG1 = micG1
    ctrlMicG2 = micG2
    ctrlMicG3 = micG3
    ctrlMicD1 = micD1
    ctrlMicD2 = micD2
    ctrlMicD3 = micD3
    ctrlMasseSurfaciqueGG = ThisWorkbook.Names("masseSurfaciqueGG").RefersToRange.Value
    ctrlMasseSurfaciqueGC = ThisWorkbook.Names("masseSurfaciqueGC").RefersToRange.Value
    ctrlMasseSurfaciqueDC = ThisWorkbook.Names("masseSurfaciqueDC").RefersToRange.Value
    ctrlMasseSurfaciqueDD = ThisWorkbook.Names("masseSurfaciqueDD").RefersToRange.Value
    ctrlBain = ThisWorkbook.Names("bain").RefersToRange.Value
    ctrlLoi = ThisWorkbook.Names("loi").RefersToRange.Value
    Dim at59Val As Variant
    at59Val = PRODUCTION_WS.Range("AT59").Value
    If at59Val = "" Or IsEmpty(at59Val) Then
        ctrlSavedOnRoll = ""
    Else
        ctrlSavedOnRoll = at59Val
    End If

    ' Vider la plage des commentaires sur PROD
    PRODUCTION_WS.Range(RANGE_SHIFT_COMMENTAIRES).Value = ""

    ' Déclaration unique de colStart
    Dim colStart As Long
    ' Gestion automatique des en-têtes pour les colonnes ctrl*
    If ws.Cells(1, 1).Value = "" Then
        ws.Cells(1, 1).Value = "ID"
        ws.Cells(1, 2).Value = "DatePoste"
        ws.Cells(1, 3).Value = "Operateur"
        ws.Cells(1, 4).Value = "Vaccation"
        ws.Cells(1, 5).Value = "Duree"
        ws.Cells(1, 6).Value = "MachinePrisePoste"
        ws.Cells(1, 7).Value = "LgEnrouleePrisePoste"
        ws.Cells(1, 8).Value = "MachineFinPoste"
        ws.Cells(1, 9).Value = "LgEnrouleeFinPoste"
        ws.Cells(1, 10).Value = "Commentaires"
        ws.Cells(1, 11).Value = "SaveDateTime"
        colStart = 12
        ws.Cells(1, colStart).Value = "ctrlMoyenneMicG"
        ws.Cells(1, colStart + 1).Value = "ctrlMoyenneMicD"
        ws.Cells(1, colStart + 2).Value = "ctrlMicG1"
        ws.Cells(1, colStart + 3).Value = "ctrlMicG2"
        ws.Cells(1, colStart + 4).Value = "ctrlMicG3"
        ws.Cells(1, colStart + 5).Value = "ctrlMicD1"
        ws.Cells(1, colStart + 6).Value = "ctrlMicD2"
        ws.Cells(1, colStart + 7).Value = "ctrlMicD3"
        ws.Cells(1, colStart + 8).Value = "ctrlMasseSurfaciqueGG"
        ws.Cells(1, colStart + 9).Value = "ctrlMasseSurfaciqueGC"
        ws.Cells(1, colStart + 10).Value = "ctrlMasseSurfaciqueDC"
        ws.Cells(1, colStart + 11).Value = "ctrlMasseSurfaciqueDD"
        ws.Cells(1, colStart + 12).Value = "ctrlBain"
        ws.Cells(1, colStart + 13).Value = "ctrlLoi"
        ws.Cells(1, colStart + 14).Value = "ctrlSavedOnRoll"
    End If
    ' Export dans la feuille à la fin de la ligne
    colStart = ws.Cells(nextRow, ws.Columns.Count).End(xlToLeft).Column + 1
    ws.Cells(nextRow, colStart).Value = ctrlMoyenneMicG
    ws.Cells(nextRow, colStart + 1).Value = ctrlMoyenneMicD
    ws.Cells(nextRow, colStart + 2).Value = ctrlMicG1
    ws.Cells(nextRow, colStart + 3).Value = ctrlMicG2
    ws.Cells(nextRow, colStart + 4).Value = ctrlMicG3
    ws.Cells(nextRow, colStart + 5).Value = ctrlMicD1
    ws.Cells(nextRow, colStart + 6).Value = ctrlMicD2
    ws.Cells(nextRow, colStart + 7).Value = ctrlMicD3
    ws.Cells(nextRow, colStart + 8).Value = ctrlMasseSurfaciqueGG
    ws.Cells(nextRow, colStart + 9).Value = ctrlMasseSurfaciqueGC
    ws.Cells(nextRow, colStart + 10).Value = ctrlMasseSurfaciqueDC
    ws.Cells(nextRow, colStart + 11).Value = ctrlMasseSurfaciqueDD
    ws.Cells(nextRow, colStart + 12).Value = ctrlBain
    ws.Cells(nextRow, colStart + 13).Value = ctrlLoi
    ws.Cells(nextRow, colStart + 14).Value = ctrlSavedOnRoll
    
    Call ClearGlobalsCtrlValues
    Call ClearTimeLostRange
    call ShiftsRotate
    call ShiftMachineRotate
    PRODUCTION_WS.Range("BG77").Value = "isFirst"
    PRODUCTION_WS.Range("AD49").Value = ""
    PRODUCTION_WS.Range("AD50").Value = "" 
    MsgBox "Le poste a été enregistré avec succès.", vbInformation, "Enregistrement réussi"
End Sub
